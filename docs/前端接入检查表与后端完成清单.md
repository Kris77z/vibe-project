# 前端接入检查表与后端完成清单（MVP）

## 〇、核心功能概览

### 一句话总结

**后端已经搭建好了一套强大、灵活的人员信息“安保系统”。**

现在，系统能严格控制**“谁（Who）”**能在**“什么范围（Where）”**内，看到**“哪些人（Whom）”**的**“哪些信息（What）”**。前端只需要按照约定好的接口来取数据和展示，就能确保数据安全合规。

### 后端完成的核心功能点

1.  **实现了“千人千面”的通讯录和人员列表**
    - **你是谁，决定你能看见谁**：普通员工、部门主管（如 `Jelly`）、超级管理员（如 `jiangziyi`）登录后，看到的员工列表范围是完全不同的，由后端根据其身份和组织架构关系动态计算。
    - **支持“隐身”和“圈地”**：可以灵活配置某个员工或整个部门“隐藏”，或限制某人“只能看自己/本部门”。

2.  **给每个信息字段都贴上了“保密等级”**
    - 所有人员字段（姓名、手机、身份证号等）被分为**公开、内部、敏感、极敏感**4个等级。
    - 后端会根据你的身份，决定给你看哪个等级的信息。前端无需再操心判断，只需向后端请求“我能看的字段列表”，然后照着渲染即可。

3.  **赋予了“主管”特殊的查看权限**
    - 只要后台将某人设为部门负责人，他就能自动看到所辖部门员工的**部分内部信息**（如工号、在职状态等白名单字段），方便管理。

4.  **打造了一把能限时、限范围的“临时万能钥匙”**
    - 管理员可以给任何人开启一个“临时权限”，在**指定时间段内**，查看**某个特定信息**（比如“手机号”），到期自动失效。

5.  **提供了完整的后台管理接口**
    - 所有上述规则的配置“开关”（GraphQL API）均已备好，未来可开发管理界面，让管理员通过点击就能完成所有权限和可见性的配置。

---

## 一、前端接入检查表

- 登录与会话
  - 使用现有登录，携带 JWT 访问 GraphQL。

- 列表页（用户列表）
  - 请求：`users(filters?)`
  - 并行：`visibleFieldKeys(resource: "user")`
  - 显示：仅渲染返回的字段 key；若不含 `contact_phone`，隐藏“手机号”列（后端已将未授权字段置 null，前端再做防御隐藏）。

- 详情页（用户详情）
  - 请求：`user(id)`
  - 并行：`visibleFieldKeys(resource: "user", targetUserId: id)`
  - 显示：
    - 联系方式集：默认仅“工作邮箱”；`contact_phone`/`contact_wechat`/`contact_qq`/`contact_personal_email` 需在 visibleFieldKeys 中存在才显示。
    - 其余字段遵循 key 是否可见。

- 导出
  - 请求：`exportUsersCsv(filters?)` → 返回 CSV 字符串。
  - 无权限：后端会拒绝；前端提示“无导出权限”。

- 权限预览（验收辅助）
  - 请求：`accessPreview(resource?: "user", targetUserId?)` → roles、permissions、visibleFieldKeys。

- 管理端（仅管理员）
  - 字段查询：`fieldDefinitions()`、`fieldSets()`
  - 字段配置（需 `org_visibility:configure`）：
    - `upsertFieldDefinition(key,label,classification,selfEditable?)`
    - `upsertFieldSet(name,description?,isSystem?)`
    - `assignFieldsToSet(setName, fieldKeys)`
  - 临时授权（需 `org_visibility:configure`）：
    - `createTemporaryAccessGrant(granteeId, resource, fieldKey, action, startAt, endAt, allowCrossBoundary?)`
    - 成功后刷新 `visibleFieldKeys` 验证时效放行。

- 错误与边界
  - 403/无权限：提示“无权限访问该数据/操作”。
  - 默认隐藏未知字段；仅展示 `visibleFieldKeys` 告知的字段。

---

## 二、后端完成清单（直白版）

- 数据模型（Prisma）
  - 新增：`FieldDefinition`、`FieldSet`、`FieldSetItem`（字段分级与字段集）。
  - 新增：`TemporaryAccessGrant`（临时访问授权，含有效期/跨界标记）。

- 权限与种子
  - 超级管理员：`jiangziyi@applychart.com / 12345678` 已创建。
  - 新增角色：`hr_manager`。
  - 新增权限：`contact:read`、`user_sensitive:read`、`user_highly_sensitive:read`、`export:sensitive`、`export:highly_sensitive`、`org_visibility:configure`。
  - 分配策略：`super_admin` 拥有全部；`admin` 拥有绝大多数（除 `user:delete`）。
  - 部门负责人：`yejieli@applychart.com / 12345678` 已创建并设为默认部门负责人（`leaderUserIds`）。

- 访问控制与可见性
  - 数据模型：新增 `UserVisibility{ hidden, viewScope }`、`ViewScope` 枚举，`Department.leaderUserIds[]`；已 db push。
  - `AccessControlService`：RBAC 判断、超级管理员直通、`hasTemporaryGrant`、`createTemporaryGrant`、组织范围过滤 `getAccessibleUserWhere`、`canSeeUser`、`setUserVisibility`、`updateDepartmentLeaders`。
  - `FieldVisibilityService`：组织可见性 + 字段分级（PUBLIC/INTERNAL/SENSITIVE/HIGHLY_SENSITIVE）+ 临时授权；目标用户不可见时返回空字段集。
  - `PermissionsGuard`：`super_admin` 直通。

- GraphQL 接口（MVP）
  - 可见性/预览：
    - `visibleFieldKeys(resource, targetUserId?) -> [String]`
    - `accessPreview(resource?, targetUserId?) -> String(JSON)`
  - 用户：
    - `users(filters?)`、`user(id)`：已按可见性置空未授权字段（如 `phone=null`）。
    - `exportUsersCsv(filters?)`：按可见性与导出权限裁剪列。
  - 字段配置（仅管理员）：
    - `fieldDefinitions()`、`fieldSets()`
    - `upsertFieldDefinition(...)`、`upsertFieldSet(...)`、`assignFieldsToSet(...)`
  - 临时授权（仅管理员）：
    - `createTemporaryAccessGrant(granteeId, resource, fieldKey, action, startAt, endAt, allowCrossBoundary?, scopeDepartmentId?)`（Mutation）
  - 主管可见白名单（后端已生效）：
    - 当 viewer 为目标用户部门链路负责人时，自动可见：name, department, position, employee_no, employment_status, join_date, contact_work_email。
  - 可见性管理（仅管理员）：
    - `setUserVisibility(userId, hidden?, viewScope?)`（Mutation）
    - `updateDepartmentLeaders(departmentId, leaderUserIds[])`（Mutation）

- 应用集成与构建
  - 新增并注册：`AccessControlModule`、`FieldVisibilityModule`。
  - 多次构建与 db push 校验通过。

- 策略与约束（已生效）
  - 公司为硬边界；事业部硬边界关闭。
  - 联系方式：仅“工作邮箱”全员可见；“手机号/微信/QQ/个人邮箱”需授权。
  - 假期余额：仅 HR 可见（字段落库后即按相同策略接入）。

---

## 三、下一步建议（前端）

- 列表与详情：并行 `visibleFieldKeys`，严格按返回 key 渲染；对后端 `null` 字段做防御隐藏。
- 导出：直接调用 `exportUsersCsv`；错误提示无导出权限。
- 临时授权：管理员提交授权后刷新可见性；用 `accessPreview` 做验收。

---

## 四、逐页联调表（页面 → 接口 → 显隐规则 → 权限）

### 1) 用户列表页
- 接口：
  - 必选：`users(filters?)`
  - 必选：`visibleFieldKeys(resource: "user")`
- 显隐规则：
  - 列集合 = 设计列 ∩ `visibleFieldKeys`
  - 若 `contact_phone` 不存在：隐藏“手机号”列；即便后端返回 `phone=null`，仍需前端隐藏列标题与单元格。
- 权限：
  - `user:read` 才能访问列表；`contact:read` 才能显示“手机号”等内部联系方式。

### 2) 用户详情页
- 接口：
  - 必选：`user(id)`
  - 建议：`visibleFieldKeys(resource: "user", targetUserId: id)`
- 显隐规则：
  - 仅渲染 `visibleFieldKeys` 中存在的字段；
  - 联系方式：默认只显示“工作邮箱”；其余联系方式字段仅在 keys 中存在时显示；
  - 对可能为 `null` 的字段（后端置空），前端兜底隐藏。
- 权限：
  - `user:read`；内部联系方式需 `contact:read`；敏感/极敏感需 `user_sensitive:read` / `user_highly_sensitive:read` 或临时授权。

### 3) 导出弹窗/操作
- 接口：
  - 必选：`exportUsersCsv(filters?)`
- 显隐规则：
  - 不做前端拼列；直接使用后端返回的 CSV；
  - 失败提示：“无导出权限”或后端错误信息。
- 权限：
  - 基础导出依赖 `export:sensitive`/`export:highly_sensitive`；
  - 字段仍受 `visibleFieldKeys` 与导出权限裁剪；无权限时列将被移除或脱敏。

### 4) 权限预览页（验收辅助）
- 接口：
  - 必选：`accessPreview(resource?: "user", targetUserId?)`
- 显隐规则：
  - 仅展示返回 JSON 中的 `roles`、`permissions`、`visibleFieldKeys`；
  - 用于对照页面实际展示，做快速验收。
- 权限：
  - 登录用户即可；依赖 `JwtAuthGuard`。

### 5) 字段配置页（仅管理员）
- 接口：
  - 查询：`fieldDefinitions()`、`fieldSets()`
  - 变更：`upsertFieldDefinition(...)`、`upsertFieldSet(...)`、`assignFieldsToSet(...)`
- 显隐规则：
  - 只对管理员显示；操作完成后刷新字段与集合列表；
  - 切勿前端写死字段集，统一读取后端配置。
- 权限：
  - 需 `org_visibility:configure`。

---

## 五、GraphQL 示例请求合集（可直接复制到客户端）

> 说明：以下示例假设已登录并在 Header 中携带 `Authorization: Bearer <token>`。

### 1) 可见字段 keys
```
query VisibleFieldKeys($resource: String!, $targetUserId: String) {
  visibleFieldKeys(resource: $resource, targetUserId: $targetUserId)
}

// variables
{
  "resource": "user",
  "targetUserId": "<目标用户ID>"
}
```

### 2) 权限预览（验收）
```
query AccessPreview($resource: String, $targetUserId: String) {
  accessPreview(resource: $resource, targetUserId: $targetUserId)
}

// variables
{
  "resource": "user",
  "targetUserId": "<目标用户ID>"
}
```

### 3) 用户列表与详情
```
query Users($filters: UserFiltersInput) {
  users(filters: $filters) {
    total
    users { id name username email phone department { id name } }
  }
}

query User($id: String!) {
  user(id: $id) { id name username email phone department { id name } }
}
```

### 4) 导出 CSV
```
query ExportUsers($filters: UserFiltersInput) {
  exportUsersCsv(filters: $filters)
}
```

### 5) 字段查询与配置（仅管理员）
```
query FieldDefs {
  fieldDefinitions
  fieldSets
}

mutation UpsertFieldDefinition($key: String!, $label: String!, $cls: String!, $self: Boolean) {
  upsertFieldDefinition(key: $key, label: $label, classification: $cls, selfEditable: $self)
}

mutation UpsertFieldSet($name: String!, $desc: String, $sys: Boolean) {
  upsertFieldSet(name: $name, description: $desc, isSystem: $sys)
}

mutation AssignFields($setName: String!, $keys: [String!]!) {
  assignFieldsToSet(setName: $setName, fieldKeys: $keys)
}
```

### 6) 临时访问授权（仅管理员）
```
mutation CreateGrant {
  createTemporaryAccessGrant(
    granteeId: "<用户ID>"
    resource: "user"
    fieldKey: "contact_phone"
    action: "read"
    startAt: "2025-09-05T00:00:00.000Z"
    endAt: "2025-09-12T00:00:00.000Z"
    allowCrossBoundary: false
  )
}
```

### 6) 临时授权页（仅管理员）
- 接口：
  - `createTemporaryAccessGrant(granteeId, resource, fieldKey, action, startAt, endAt, allowCrossBoundary?)`
- 显隐规则：
  - 提交成功后提示“临时授权已生效至 endAt”，并引导刷新页面或调用 `visibleFieldKeys` 验证；
  - 建议显示当前生效中的 grant 列表（可后续补充查询接口）。
- 权限：
  - 需 `org_visibility:configure`。


