# 字段可见性两档方案（公开/保密）

> 依据最新决策，字段可见性统一收敛为两档：公开与保密；移除“敏感”与“主管可见”。同时新增 HR-公司范围校验（基于员工 EAV 字段 `company_belong`）。

## 1. 分级定义（仅两档）
- 公开 PUBLIC：系统内所有登录用户可见（默认）。
- 保密 CONFIDENTIAL：仅管理员可见（`admin`/`super_admin`），以及同公司 HR 可见。

旧→新映射：
- PUBLIC/INTERNAL → PUBLIC
- SENSITIVE/HIGHLY_SENSITIVE → 统一并入 CONFIDENTIAL

## 2. HR-公司范围校验
- HR 仅能查看“其所在公司”的保密信息；跨公司不可见。
- 公司判定来源：目标员工与查看者的 EAV 字段 `company_belong`。
- 管理员不受此限制。

## 3. 默认公开字段
- 基本信息：整组公开（含“手机号 contact_phone、工作邮箱 contact_work_email”）。
- 工作信息：人员状态 `employment_status`、所属事业部 `business_unit`、部门 `department`、职务/岗位 `position` 公开；其余保密。
- 个人信息：英文名 `english_name`、性别 `gender` 公开；其余保密。
- 其他分组/明细模块（教育/工作/紧急联系人/家庭/合同/证件/银行/资料附件）：保密。

## 4. 前端交互（仅两档）
- 分组标题行：分级选择器（公开/保密）+ “应用到本组”。
- 不提供字段级覆盖与“主管可见”。
- 详情页不显示分级徽标，仅按权限遮罩值。

## 5. 后端数据结构与接口调整
- Enum：`FieldClassification = PUBLIC | CONFIDENTIAL`。
- 表：`FieldDefinition` 移除 `allowManagerVisible` 字段；保留 `classification`。
- 表：`ModuleVisibility` 仅保留 `moduleKey, classification, updatedAt`。
- 服务：`FieldVisibilityService` 判定：
  - PUBLIC → true；
  - CONFIDENTIAL → `isAdmin(viewer) || (isHR(viewer) && sameCompany(viewer,target))`。
- GraphQL：
  - 查询：`fieldDefinitions`, `visibleFieldKeys(resource,targetUserId)`；
  - 变更：`upsertFieldDefinition(key,label,classification)`；
    分组/模块一键应用接口：`applyGroupVisibility(groupKey, classification, overwrite:boolean)`、`applyModuleVisibility(moduleKey, classification)`。

## 6. 迁移与兼容
- Prisma 枚举由三档改两档；删除 `allowManagerVisible`；数据中 SENSITIVE/HIGHLY_SENSITIVE 映射为 CONFIDENTIAL。
- 种子与批量应用：按“默认公开字段”一次性落库；前端文案统一替换为“公开/保密”。

## 7. 验收要点
- HR 仅对本公司人员的保密信息可见，跨公司不可见；管理员全可见；普通成员仅见公开。
- 分组批量应用后组内不再混搭；详情页无分级徽标，仅正确遮罩。

---

## 8. 人员导入功能

### 支持的文件格式
- **Excel (.xlsx/.xls)**：自动解析第一个工作表，忽略合并单元格和公式
- **CSV (.csv)**：标准逗号分隔格式
- **Markdown (.md)**：表格格式
- **文本粘贴**：直接在界面中粘贴表格数据

### 必需字段与可选字段
- **必需**：姓名、邮箱
- **可选**：部门、手机、员工编码

### 表头格式示例
```csv
姓名,邮箱,部门,手机,员工编码
张三,zhangsan@example.com,产品部,13800000000,EMP001
李四,lisi@example.com,测试部,13900000000,EMP002
```

### 导入行为
- **员工编码存在**：更新现有用户信息
- **员工编码为空**：创建新用户（系统分配ID）
- **部门匹配**：根据部门名称自动关联，不存在则留空
- **密码生成**：新用户默认密码为 `123456`

### 错误处理
- 重复邮箱：跳过并记录错误
- 无效邮箱格式：跳过并记录错误
- 缺少必需字段：跳过并记录错误
- 导入完成后显示统计：新增数量、跳过数量、错误详情

### 模板下载
- 人员管理页面提供Excel和CSV模板下载
- 模板包含完整的字段说明和示例数据

---

若后续需要"跨公司 HR 协作"或"临时授权"，可在此两档之上新增授权令牌/审计日志，不改变两档核心判定。
